<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
            "http://www.w3.org/TR/REC-html40/loose.dtd">

  <html>

    <head>
      <meta	http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
	<meta	name=keywords content="Abora,Xanadu,Xanalogical,Udana-Gold,Hypertext,Java,Smalltalk,Dolphin Smalltalk">
	  <title>Udanax-Gold2Java</title>
    </head>

    <body>
<!-- abora:header -->

      <h1>Udanax-Gold2Java</h1>

The <i>UdanaxGold2Java</i> project contains a number of sub-components
related to converting the released Udanax-Gold Smalltalk and C++
source code by XOC into Java source code. The aim is to provide a
first pass automatic translation of as much of the code as possible.
The end result is <b>not</b> compilable but may prove useful for
non-Smalltalk users who are interested in reading the Udanax-Gold
source code.

The project is split up into three sections:
		<ul>
			<li>The <b>udanax-gold</b> sub-directory holds a few versions of the
			Udanax-Gold source code as supplied by XOC. This code was
			released under a MIT open-source licence.</li>

			<li>The <b>translator</b> sub-directory implements a simple Java
			translator that is used to convert from the Udanax-Gold
			Smalltalk source to (approximately) Java - though with lots of
			remaining compilation problems.</li>

			<li>The <b>abora-gold</b> sub-directory holds the translated
			Udanax-Gold code. This includes the result of the translator
			application and some hand coded translated classes from C++ code
			plus some place-holder classes for source that has not been
			released by XOC yet but is referenced by translated source.</li>
		</ul>

<table width="100%" bgcolor="antiquewhite">
	<tr>
	  <td>
<h3>Translator</h3>
				</td>
			</tr>
		</table>

<p>The Translator is a small Java app to automatically translate from the
<b>Udanax-Gold</b> Smalltalk(ish) source code into (approximate) Java. The
end result will <b>not</b> be compilable (currently ~5000 compilation
problems), but may prove useful for non-Smalltalk users who are
interested in reading the Udanax-Gold code and also forms the basis of my
Abora-White project.</p>

<p>Translating from Smalltalk source code to Java code is normally a
very difficult proposition as Smalltalk source does not include
declared types. Thankfully as a requirement for XOCs own translator to
X++, their variant of C++, the typing information is present in the
source code. Unfortunately there are a number of complications; still
a lot of work to carry out without that much information on what the
X++ translator did, plus the features and restrictions of Java aren't
a perfect match for X++, one example is the stricter handling of
statics in Java and the inability to have an instance and static
method of the same class with the same signature.</p>
			

<h4>Using the Translator</h4>

<p>The easiest route to using the Translator is the Ant <tt>build.xml</tt> file
present in this directory.</p>

<p>Once you have Java JDK 1.4+, Ant 1.5.1+, JUnit 3.8.1 set up, just run
the following from the command line:</p>

<tt>> <b>ant</b></tt>

<p>You should see some logging info summarising the walk through of a
number of source Smalltalk files, and a larger number of generated
Java files. The process should take less than a minute on a reasonable
machine. You should find approximately 500 classes generated.</p>

<p>The generated Java files are placed in <tt>../abora-gold/src-gen directory</tt>
under the <tt>org.abora.gold</tt> Java package. </p>


<h4>Extending the Translator</h4>

<p>Good Luck! This code was meant to be a throw away weekend project but
I had to end up extending it quite significantly. Still there isn't
too much code here, and there is some test coverage of the in-method
transformations.</p>

<p>The JUnit tests are present in the <tt>org.abora.ug2java.tests.TestWriteMethod</tt>
class, and can be run courtesy of ant:</p>

<tt>> <b>ant test</b></tt>


<p><tt>TranslateSmalltalk.main(...)</tt> is the entry point taking an output
directory, and a number of source Smalltalk files to process.</p>

<p>The Smalltalk files are stored in a version of the classic Smalltalk
Chunk format which effectively has a sequence of chunks of text with a
terminating exclamation mark (!). A chunk can define a new class,
define a method of a specific method category and arbitrary Smalltalk
expressions. More than one class can be defined in each source file.</p>

<p>There are two major passes over the source by TranslateSmalltalk.</p>

<p>The first pass reads in each of the Smalltalk source files in turn.
For each included class a <tt>ClassWriter</tt> is created and initialised with
its name, superclass, etc. Also each related chunk is read and either
added to the classWriter as a simple comment or an instance or static
method. The Java package of a class is based on its Smalltalk class
category, and is recorded for each class so that appropriate Java
import statements can be generated later.</p>

<p>The second pass walks through each <tt>ClassWriter</tt> requesting it to write
out a suitable .java file for itself. At this point each of its methods
is translated into Java and written out as part of the class
definition.</p>

<p>The Smalltalk source for a method is parsed using a <tt>SmalltalkScanner</tt>
which returns a series of <tt>ScannerTokens</tt>. These are simple token
interpretation of the Smalltalk with type and value. This series of
ScannerTokens is in turn converted into a sequence of sub-instances of
<tt>JavaToken</tt>. A series of <tt>transformX</tt> methods then walk the sequence of
Java tokens applying suitable transformations to move things closer to
the desired form. One transformation is to remove references to self
if necessary, another converts create(...) method calls to a
constructor call for the appropriate class.</p>

<p>Writing out a text version of the Java tokens is accomplished by
simply visiting each token in turn and appending to the current method
output. No effort is expended to indent statements correctly and also
some extra spaces will be inserted against standard Java formatting.
Additionally the original Smalltalk source is appended at the end of
the method together with the file and line number from where it came
to help with further manual corrections as may be needed later.</p>


<h4>Future Translator Improvements</h4>

<p>I'm not sure how much further effort I am going to expend on the
translator, but considering the level of Java compilation problems
present in the translation code there is scope for lots of
improvements :-)</p>

<ul>
		<li>Bugs trying to find beginning of expression</li>
		<li>Bracketting if/while expressions</li>
		<li>Convert more of the block cases; DiskManager.consistent, forEach,
etc</li>
		<li>Use Java abstract method/class support</li>
		<li>Cast if appropriate to result of make(...) calls</li>
		<li>Sort out <tt>IntegerVar</tt>/<tt>BooleanVar</tt> support, which may require working out
the type of fields and calls to make up for lack of C++ operator
overloading for converting between these classes and primitives and
equivalents of primitive operations such as +</li>
		<li>Indent resulting Java code rather than relying on an external source
formatter to be applied against the generated code</li>
		<li>Converting to a more standard parse tree may clear up some of the
code</li>
		<li>Try and define the transformations as parse-tree modifications in a
Refactoring or XLST fashion rather than existing primitive Java code</li>
		<li>Gain documents for XOCs own translator to C++ for a better handle
on what should be happening - for example class attributes such as ON.CLIENT</li>
		<li>Tidying up the code!</li>


<!-- abora:footer -->
    </body>
  </html>
